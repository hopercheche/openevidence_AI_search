# OpenEvidence Backend API - Baichuan M2 Plus

åŸºäº Baichuan M2 Plus æ¨¡å‹çš„åŒ»å­¦é—®ç­”ç³»ç»Ÿåç«¯æœåŠ¡ï¼Œæ”¯æŒæµå¼å“åº”å’Œæ™ºèƒ½å¼•ç”¨æ ‡è®°ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

1. **Python 3.8+**
2. **Baichuan API Key** - ä» [ç™¾å·æ™ºèƒ½](https://platform.baichuan-ai.com/) è·å–

### å®‰è£…æ­¥éª¤

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd openevidence-backend

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®ä½ çš„ Baichuan API Key

# 3. è¿è¡Œå¯åŠ¨è„šæœ¬
chmod +x start.sh
./start.sh
```

### æ‰‹åŠ¨å®‰è£…

```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ– venv\Scripts\activate  # Windows

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. è®¾ç½®ç¯å¢ƒå˜é‡
export BAICHUAN_API_KEY="sk-xxx"  # æ›¿æ¢ä¸ºä½ çš„ API Key

# 4. å¯åŠ¨æœåŠ¡
python app.py
```

## âš™ï¸ é…ç½®è¯´æ˜

### å¿…éœ€é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ä»¥ä¸‹å¿…éœ€å‚æ•°ï¼š

```bash
# Baichuan M2 Plus API é…ç½®
BAICHUAN_API_KEY=sk-xxx  # ä½ çš„ Baichuan API Key
BAICHUAN_BASE_URL=https://api.baichuan-ai.com/v1/
```

### å¯é€‰é…ç½®

```bash
# æœåŠ¡å™¨é…ç½®
HOST=0.0.0.0
PORT=8000
FLASK_ENV=development

# LLM å‚æ•°
LLM_TEMPERATURE=0.1      # æ§åˆ¶å›ç­”çš„éšæœºæ€§ (0-1)
LLM_MAX_TOKENS=2000      # æœ€å¤§è¾“å‡ºé•¿åº¦
LLM_TOP_P=0.9           # æ ¸é‡‡æ ·å‚æ•°

# æµå¼å“åº”é…ç½®
STREAMING_WORD_DELAY=0.05    # è¯é—´å»¶è¿Ÿï¼ˆç§’ï¼‰
STREAMING_SEGMENT_DELAY=0.2  # æ®µè½é—´å»¶è¿Ÿï¼ˆç§’ï¼‰
```

## ğŸ“¡ API ç«¯ç‚¹

### å¥åº·æ£€æŸ¥
```http
GET /health
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "healthy",
  "version": "2.0.0",
  "model": "Baichuan-M2-Plus",
  "services": {
    "llm": true,
    "citation": true,
    "streaming": true
  }
}
```

### æ¨¡å‹çŠ¶æ€
```http
GET /api/model/status
```

### åŒ»å­¦é—®ç­”ï¼ˆæµå¼å“åº”ï¼‰
```http
POST /api/ask
Content-Type: application/json

{
  "question": "25å²å¥åº·å¥³æ€§ç§æ¤ç‰™ï¼Œåˆšåšå®Œæ¤å…¥ç§æ¤ä½“ï¼Œè¯·é—®æ‰‹æœ¯åæ˜¯å¦éœ€è¦æœç”¨æŠ—ç”Ÿç´ ï¼Ÿ",
  "userId": "user123",
  "sessionId": "session456"
}
```

**æµå¼å“åº”æ ¼å¼ï¼š**

1. **æ€è€ƒè¿›åº¦**
```json
{
  "type": "thinking_progress",
  "step": "æœç´¢åŒ»å­¦æ–‡çŒ®ã€æŒ‡å—ã€è¯å“è¯´æ˜ä¹¦ç­‰",
  "status": "in_progress"
}
```

2. **å¼•ç”¨åŠ è½½**
```json
{
  "type": "references_loaded",
  "references": [...],
  "count": 12
}
```

3. **å†…å®¹è¾“å‡º**
```json
{
  "content": "å¯¹äºä¸€å25å²ã€ç³»ç»Ÿæ€§å¥åº·ã€åˆšå®Œæˆå¸¸è§„ç§æ¤ä½“æ¤å…¥çš„å¥³æ€§æ‚£è€…ï¼Œ",
  "citations": [1, 2],
  "isComplete": false
}
```

4. **å®Œæˆå“åº”**
```json
{
  "isComplete": true,
  "references": [...],
  "followUpQuestions": [...],
  "totalContent": "å®Œæ•´å›ç­”å†…å®¹"
}
```

## ğŸ”„ Baichuan M2 Plus é›†æˆç‰¹æ€§

### 1. æ™ºèƒ½æ€è€ƒè¿‡ç¨‹
- å®æ—¶æ˜¾ç¤ºæ¨¡å‹æ€è€ƒæ­¥éª¤
- åŒ…æ‹¬é—®é¢˜ç†è§£ã€æ–‡çŒ®æœç´¢ã€ä¿¡æ¯æ•´åˆç­‰é˜¶æ®µ

### 2. è‡ªåŠ¨å¼•ç”¨æ ‡è®°
- è‡ªåŠ¨è¯†åˆ«æ–‡æœ¬ä¸­çš„å¼•ç”¨æ ‡è®° `^[1]^`
- å®æ—¶è§£æå¹¶å…³è”åˆ°å…·ä½“æ–‡çŒ®
- æ”¯æŒå¤šç§å¼•ç”¨æ ¼å¼

### 3. åŒ»å­¦æ–‡çŒ®æ”¯æŒ
- è‡ªåŠ¨ä» PubMedã€Cochrane ç­‰æ•°æ®åº“è·å–æ–‡çŒ®
- åŒ…å«å®Œæ•´çš„æ–‡çŒ®å…ƒæ•°æ®ï¼ˆä½œè€…ã€æœŸåˆŠã€DOIç­‰ï¼‰
- æ™ºèƒ½åˆ†ç±»æ–‡çŒ®ç±»å‹ï¼ˆRCTã€ç³»ç»Ÿè¯„ä»·ã€æŒ‡å—ç­‰ï¼‰

### 4. æµå¼å“åº”ä¼˜åŒ–
- é€è¯è¾“å‡ºï¼Œæ¨¡æ‹ŸçœŸå®æ‰“å­—æ•ˆæœ
- æ™ºèƒ½æ®µè½åˆ†å‰²
- å¼•ç”¨æ ‡è®°å®æ—¶æ’å…¥

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
openevidence-backend/
â”œâ”€â”€ app.py                    # Flask ä¸»åº”ç”¨
â”œâ”€â”€ config.py                # é…ç½®ç®¡ç†
â”œâ”€â”€ models/
â”‚   â””â”€â”€ baichuan_client.py   # Baichuan API å®¢æˆ·ç«¯
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ llm_service.py       # LLM æœåŠ¡å±‚
â”‚   â”œâ”€â”€ citation_service.py  # å¼•ç”¨ç®¡ç†
â”‚   â””â”€â”€ streaming_service.py # æµå¼å“åº”å¤„ç†
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ citation_parser.py   # å¼•ç”¨è§£æå·¥å…·
â”‚   â””â”€â”€ text_processor.py    # æ–‡æœ¬å¤„ç†å·¥å…·
â””â”€â”€ tests/
    â””â”€â”€ test_baichuan_api.py # API æµ‹è¯•è„šæœ¬
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

1. **BaichuanClient** - å°è£… Baichuan API è°ƒç”¨
2. **LLMService** - å¤„ç†é—®ç­”é€»è¾‘å’Œæç¤ºè¯ç®¡ç†
3. **CitationParser** - è§£æå¼•ç”¨æ ‡è®°å’Œæ–‡çŒ®ä¿¡æ¯
4. **StreamingService** - ç®¡ç†æµå¼å“åº”çš„å¤„ç†æµç¨‹

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•è„šæœ¬
```bash
python test_baichuan_api.py
```

### æ‰‹åŠ¨æµ‹è¯•

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æµ‹è¯•é—®ç­” API
curl -X POST http://localhost:8000/api/ask \
  -H "Content-Type: application/json" \
  -d '{
    "question": "25å²å¥åº·å¥³æ€§ç§æ¤ç‰™ï¼Œåˆšåšå®Œæ¤å…¥ç§æ¤ä½“ï¼Œè¯·é—®æ‰‹æœ¯åæ˜¯å¦éœ€è¦æœç”¨æŠ—ç”Ÿç´ ï¼Ÿ",
    "userId": "test_user"
  }'
```

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„åŒ»å­¦é¢†åŸŸ

1. **æ‰©å±•ç³»ç»Ÿæç¤ºè¯**ï¼ˆ`services/llm_service.py`ï¼‰ï¼š
```python
def _get_system_prompt(self) -> str:
    return """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŒ»å­¦é—®ç­”åŠ©æ‰‹...
    
    ä¸“ä¸šé¢†åŸŸåŒ…æ‹¬ï¼š
    - å£è…”åŒ»å­¦å’Œç§æ¤ç‰™ç§‘
    - å¿ƒè¡€ç®¡ç–¾ç—…ç®¡ç†
    - å†…åˆ†æ³Œç–¾ç—…æ²»ç–—
    - [æ–°å¢é¢†åŸŸ]
    """
```

2. **æ·»åŠ é¢†åŸŸç‰¹å®šçš„åç»­é—®é¢˜**ï¼ˆ`services/llm_service.py`ï¼‰ï¼š
```python
def generate_follow_up_questions(self, original_question: str, answer_content: str):
    if "æ–°é¢†åŸŸå…³é”®è¯" in original_question:
        return [
            "æ–°é¢†åŸŸç›¸å…³é—®é¢˜1ï¼Ÿ",
            "æ–°é¢†åŸŸç›¸å…³é—®é¢˜2ï¼Ÿ",
            "æ–°é¢†åŸŸç›¸å…³é—®é¢˜3ï¼Ÿ"
        ]
```

### è‡ªå®šä¹‰å¼•ç”¨è§£æ

ä¿®æ”¹ `utils/citation_parser.py` ä¸­çš„è§£æè§„åˆ™ï¼š

```python
def __init__(self):
    # æ·»åŠ æ–°çš„å¼•ç”¨æ ¼å¼
    self.citation_patterns = [
        r'\^?\[(\d+(?:,\s*\d+)*)\]\^?',  # ç°æœ‰æ ¼å¼
        r'<ref>(\d+)</ref>',             # æ–°æ ¼å¼
    ]
```

### è°ƒæ•´æµå¼å“åº”é€Ÿåº¦

åœ¨ `.env` æ–‡ä»¶ä¸­ä¿®æ”¹ï¼š
```bash
STREAMING_WORD_DELAY=0.03    # æ›´å¿«
STREAMING_SEGMENT_DELAY=0.1  # æ›´å¿«çš„æ®µè½åˆ‡æ¢
```

## ğŸš€ éƒ¨ç½²

### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t openevidence-backend .

# è¿è¡Œå®¹å™¨
docker run -d \
  -p 8000:8000 \
  -e BAICHUAN_API_KEY=sk-xxx \
  --name openevidence-backend \
  openevidence-backend
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **ä½¿ç”¨ Gunicorn**ï¼š
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

2. **ä½¿ç”¨ Nginx åå‘ä»£ç†**ï¼š
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # æ”¯æŒæµå¼å“åº”
        proxy_buffering off;
        proxy_cache off;
    }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ä¼˜åŒ–
```python
# å¯ç”¨å¼•ç”¨ç¼“å­˜
REFERENCE_CACHE_SIZE=1000

# ä½¿ç”¨ Redis ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
REDIS_URL=redis://localhost:6379/0
```

### 2. å¹¶å‘å¤„ç†
```python
# ä½¿ç”¨å¤šè¿›ç¨‹
gunicorn -w 4 app:app

# æˆ–ä½¿ç”¨å¼‚æ­¥å¤„ç†
pip install gevent
gunicorn -k gevent -w 4 app:app
```

### 3. å“åº”é€Ÿåº¦è°ƒä¼˜
```bash
# å‡å°‘å»¶è¿Ÿ
STREAMING_WORD_DELAY=0.02
LLM_MAX_TOKENS=1500

# ä¼˜åŒ–æ¨¡å‹å‚æ•°
LLM_TEMPERATURE=0.05  # æ›´ç¡®å®šçš„å›ç­”
LLM_TOP_P=0.8        # æ›´èšç„¦çš„è¾“å‡º
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **API Key é”™è¯¯**
```
Error: Invalid API key
è§£å†³: æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ BAICHUAN_API_KEY è®¾ç½®
```

2. **ç½‘ç»œè¿æ¥é—®é¢˜**
```
Error: Connection timeout
è§£å†³: æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
```

3. **æµå¼å“åº”ä¸­æ–­**
```
Error: Stream interrupted
è§£å†³: æ£€æŸ¥å®¢æˆ·ç«¯è¶…æ—¶è®¾ç½®ï¼Œå¢åŠ  timeout å€¼
```

4. **å¼•ç”¨è§£æå¤±è´¥**
```
Warning: Citation parsing failed
è§£å†³: æ£€æŸ¥å¼•ç”¨æ ¼å¼ï¼Œç¡®ä¿ç¬¦åˆ ^[1]^ æ ¼å¼
```

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```bash
export LOG_LEVEL=DEBUG
python app.py
```

æŸ¥çœ‹ Baichuan API è°ƒç”¨è¯¦æƒ…ï¼š
```python
# åœ¨ models/baichuan_client.py ä¸­æ·»åŠ 
import logging
logging.getLogger("openai").setLevel(logging.DEBUG)
```

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—é…ç½®
```python
# ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
LOG_LEVEL=INFO
LOG_FILE=/var/log/openevidence/app.log
```

### æ€§èƒ½ç›‘æ§
```python
# æ·»åŠ æ€§èƒ½æŒ‡æ ‡
@app.before_request
def before_request():
    g.start_time = time.time()

@app.after_request
def after_request(response):
    duration = time.time() - g.start_time
    logger.info(f"Request duration: {duration:.3f}s")
    return response
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ï¼š`git checkout -b feature/new-feature`
3. æäº¤æ›´æ”¹ï¼š`git commit -am 'Add new feature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/new-feature`
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ LICENSE æ–‡ä»¶

## ğŸ†˜ æ”¯æŒ

- ğŸ“§ é‚®ç®±ï¼šsupport@openevidence.com
- ğŸ“– æ–‡æ¡£ï¼šhttps://docs.openevidence.com
- ğŸ› é—®é¢˜åé¦ˆï¼šGitHub Issues

---

**æ³¨æ„ï¼š** æœ¬é¡¹ç›®éœ€è¦æœ‰æ•ˆçš„ Baichuan API Key æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚è¯·ç¡®ä¿ä»å®˜æ–¹æ¸ é“è·å– API Key å¹¶å¦¥å–„ä¿ç®¡ã€‚