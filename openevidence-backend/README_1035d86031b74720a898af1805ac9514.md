# OpenEvidence Backend API - Baichuan M2 Plus

基于 Baichuan M2 Plus 模型的医学问答系统后端服务，支持流式响应和智能引用标记。

## 🚀 快速开始

### 前置要求

1. **Python 3.8+**
2. **Baichuan API Key** - 从 [百川智能](https://platform.baichuan-ai.com/) 获取

### 安装步骤

```bash
# 1. 克隆项目
git clone <repository-url>
cd openevidence-backend

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，设置你的 Baichuan API Key

# 3. 运行启动脚本
chmod +x start.sh
./start.sh
```

### 手动安装

```bash
# 1. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或 venv\Scripts\activate  # Windows

# 2. 安装依赖
pip install -r requirements.txt

# 3. 设置环境变量
export BAICHUAN_API_KEY="sk-xxx"  # 替换为你的 API Key

# 4. 启动服务
python app.py
```

## ⚙️ 配置说明

### 必需配置

在 `.env` 文件中设置以下必需参数：

```bash
# Baichuan M2 Plus API 配置
BAICHUAN_API_KEY=sk-xxx  # 你的 Baichuan API Key
BAICHUAN_BASE_URL=https://api.baichuan-ai.com/v1/
```

### 可选配置

```bash
# 服务器配置
HOST=0.0.0.0
PORT=8000
FLASK_ENV=development

# LLM 参数
LLM_TEMPERATURE=0.1      # 控制回答的随机性 (0-1)
LLM_MAX_TOKENS=2000      # 最大输出长度
LLM_TOP_P=0.9           # 核采样参数

# 流式响应配置
STREAMING_WORD_DELAY=0.05    # 词间延迟（秒）
STREAMING_SEGMENT_DELAY=0.2  # 段落间延迟（秒）
```

## 📡 API 端点

### 健康检查
```http
GET /health
```

**响应示例：**
```json
{
  "status": "healthy",
  "version": "2.0.0",
  "model": "Baichuan-M2-Plus",
  "services": {
    "llm": true,
    "citation": true,
    "streaming": true
  }
}
```

### 模型状态
```http
GET /api/model/status
```

### 医学问答（流式响应）
```http
POST /api/ask
Content-Type: application/json

{
  "question": "25岁健康女性种植牙，刚做完植入种植体，请问手术后是否需要服用抗生素？",
  "userId": "user123",
  "sessionId": "session456"
}
```

**流式响应格式：**

1. **思考进度**
```json
{
  "type": "thinking_progress",
  "step": "搜索医学文献、指南、药品说明书等",
  "status": "in_progress"
}
```

2. **引用加载**
```json
{
  "type": "references_loaded",
  "references": [...],
  "count": 12
}
```

3. **内容输出**
```json
{
  "content": "对于一名25岁、系统性健康、刚完成常规种植体植入的女性患者，",
  "citations": [1, 2],
  "isComplete": false
}
```

4. **完成响应**
```json
{
  "isComplete": true,
  "references": [...],
  "followUpQuestions": [...],
  "totalContent": "完整回答内容"
}
```

## 🔄 Baichuan M2 Plus 集成特性

### 1. 智能思考过程
- 实时显示模型思考步骤
- 包括问题理解、文献搜索、信息整合等阶段

### 2. 自动引用标记
- 自动识别文本中的引用标记 `^[1]^`
- 实时解析并关联到具体文献
- 支持多种引用格式

### 3. 医学文献支持
- 自动从 PubMed、Cochrane 等数据库获取文献
- 包含完整的文献元数据（作者、期刊、DOI等）
- 智能分类文献类型（RCT、系统评价、指南等）

### 4. 流式响应优化
- 逐词输出，模拟真实打字效果
- 智能段落分割
- 引用标记实时插入

## 🏗️ 项目架构

```
openevidence-backend/
├── app.py                    # Flask 主应用
├── config.py                # 配置管理
├── models/
│   └── baichuan_client.py   # Baichuan API 客户端
├── services/
│   ├── llm_service.py       # LLM 服务层
│   ├── citation_service.py  # 引用管理
│   └── streaming_service.py # 流式响应处理
├── utils/
│   ├── citation_parser.py   # 引用解析工具
│   └── text_processor.py    # 文本处理工具
└── tests/
    └── test_baichuan_api.py # API 测试脚本
```

### 核心组件说明

1. **BaichuanClient** - 封装 Baichuan API 调用
2. **LLMService** - 处理问答逻辑和提示词管理
3. **CitationParser** - 解析引用标记和文献信息
4. **StreamingService** - 管理流式响应的处理流程

## 🧪 测试

### 运行测试脚本
```bash
python test_baichuan_api.py
```

### 手动测试

```bash
# 健康检查
curl http://localhost:8000/health

# 测试问答 API
curl -X POST http://localhost:8000/api/ask \
  -H "Content-Type: application/json" \
  -d '{
    "question": "25岁健康女性种植牙，刚做完植入种植体，请问手术后是否需要服用抗生素？",
    "userId": "test_user"
  }'
```

## 🔧 开发指南

### 添加新的医学领域

1. **扩展系统提示词**（`services/llm_service.py`）：
```python
def _get_system_prompt(self) -> str:
    return """你是一个专业的医学问答助手...
    
    专业领域包括：
    - 口腔医学和种植牙科
    - 心血管疾病管理
    - 内分泌疾病治疗
    - [新增领域]
    """
```

2. **添加领域特定的后续问题**（`services/llm_service.py`）：
```python
def generate_follow_up_questions(self, original_question: str, answer_content: str):
    if "新领域关键词" in original_question:
        return [
            "新领域相关问题1？",
            "新领域相关问题2？",
            "新领域相关问题3？"
        ]
```

### 自定义引用解析

修改 `utils/citation_parser.py` 中的解析规则：

```python
def __init__(self):
    # 添加新的引用格式
    self.citation_patterns = [
        r'\^?\[(\d+(?:,\s*\d+)*)\]\^?',  # 现有格式
        r'<ref>(\d+)</ref>',             # 新格式
    ]
```

### 调整流式响应速度

在 `.env` 文件中修改：
```bash
STREAMING_WORD_DELAY=0.03    # 更快
STREAMING_SEGMENT_DELAY=0.1  # 更快的段落切换
```

## 🚀 部署

### Docker 部署

```bash
# 构建镜像
docker build -t openevidence-backend .

# 运行容器
docker run -d \
  -p 8000:8000 \
  -e BAICHUAN_API_KEY=sk-xxx \
  --name openevidence-backend \
  openevidence-backend
```

### 生产环境部署

1. **使用 Gunicorn**：
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

2. **使用 Nginx 反向代理**：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 支持流式响应
        proxy_buffering off;
        proxy_cache off;
    }
}
```

## 📊 性能优化

### 1. 缓存优化
```python
# 启用引用缓存
REFERENCE_CACHE_SIZE=1000

# 使用 Redis 缓存（可选）
REDIS_URL=redis://localhost:6379/0
```

### 2. 并发处理
```python
# 使用多进程
gunicorn -w 4 app:app

# 或使用异步处理
pip install gevent
gunicorn -k gevent -w 4 app:app
```

### 3. 响应速度调优
```bash
# 减少延迟
STREAMING_WORD_DELAY=0.02
LLM_MAX_TOKENS=1500

# 优化模型参数
LLM_TEMPERATURE=0.05  # 更确定的回答
LLM_TOP_P=0.8        # 更聚焦的输出
```

## 🔍 故障排除

### 常见问题

1. **API Key 错误**
```
Error: Invalid API key
解决: 检查 .env 文件中的 BAICHUAN_API_KEY 设置
```

2. **网络连接问题**
```
Error: Connection timeout
解决: 检查网络连接和防火墙设置
```

3. **流式响应中断**
```
Error: Stream interrupted
解决: 检查客户端超时设置，增加 timeout 值
```

4. **引用解析失败**
```
Warning: Citation parsing failed
解决: 检查引用格式，确保符合 ^[1]^ 格式
```

### 调试模式

启用详细日志：
```bash
export LOG_LEVEL=DEBUG
python app.py
```

查看 Baichuan API 调用详情：
```python
# 在 models/baichuan_client.py 中添加
import logging
logging.getLogger("openai").setLevel(logging.DEBUG)
```

## 📈 监控和日志

### 日志配置
```python
# 生产环境日志
LOG_LEVEL=INFO
LOG_FILE=/var/log/openevidence/app.log
```

### 性能监控
```python
# 添加性能指标
@app.before_request
def before_request():
    g.start_time = time.time()

@app.after_request
def after_request(response):
    duration = time.time() - g.start_time
    logger.info(f"Request duration: {duration:.3f}s")
    return response
```

## 🤝 贡献指南

1. Fork 项目
2. 创建功能分支：`git checkout -b feature/new-feature`
3. 提交更改：`git commit -am 'Add new feature'`
4. 推送分支：`git push origin feature/new-feature`
5. 创建 Pull Request

## 📄 许可证

MIT License - 详见 LICENSE 文件

## 🆘 支持

- 📧 邮箱：support@openevidence.com
- 📖 文档：https://docs.openevidence.com
- 🐛 问题反馈：GitHub Issues

---

**注意：** 本项目需要有效的 Baichuan API Key 才能正常运行。请确保从官方渠道获取 API Key 并妥善保管。